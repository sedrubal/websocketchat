<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Websocket Chat</title>

    <!-- Bootstrap -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
		<style>
		#terminal {
			overflow-y: scroll;
		}
		</style>
  </head>
  <body>

		<div id="not-container" class="row" style="position:fixed;margin:0;padding:10px;top:0px;left:0px;width:100%;z-index:9999;text-align:center">
			<div id="notifications"></div>
		<!--	<div class="alert alert-info alert-dismissible fade in" role="alert">
				<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
				<strong>Welcome!</strong> Please enter your nick and start chatting.
			</div>-->
		</div>
		
		<div class="jumbotron">
			<div class="container">
				<h1>Websocket Chat</h1>
			</div>
		</div>

		<div class="container">
			<div class="row">
				<div class="input-group">
					<span class="input-group-addon" id="nick">@</span>
					<input id="nickbox" type="text" class="form-control" placeholder="Nick" aria-describedby="nickname" onkeydown="if (event.keyCode == 13) { setNick();return false;}" >
				</div>

				<div style="margin-top:1em;">
					<div id="terminal" class="well" style="height:15em"></div>
				</div>

				<div class="input-group">
					<input id="sendtxt" type="text" class="form-control" placeholder="Your Message..." onkeydown="if (event.keyCode == 13) { send();return false;}">
					<span class="input-group-btn">
						<button class="btn btn-default" type="button" onclick="send()">Send</button>
					</span>
				</div>

			</div>
		</div>

		<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js" integrity="sha384-6ePHh72Rl3hKio4HiJ841psfsRJveeS+aLoaEf3BWfS+gTF0XdAqku2ka8VddikM" crossorigin="anonymous"></script>
		<!-- Latest compiled and minified JavaScript -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
		<!--
Some javascript containing websocket code:
==========================================
		-->
		<script>
var sendtxt = document.getElementById('sendtxt');
var terminal = document.getElementById('terminal');
var nickbox = document.getElementById('nickbox');
var notdiv = $('#notifications');
sendtxt.value = "";
terminal.value = "";

nick = "Anonymous";

var ws = new WebSocket("ws://localhost:8888/websocket");

ws.onopen = function() {
	var message = {
		"action": "message",
		"data": {
			"sender": nick,
			"text": "Hello World"
		}
	}
	ws.send(JSON.stringify(message));
};

ws.onmessage = function (evt) {
	message = JSON.parse(evt.data);
	if (message.action == "message") {
		var sender = message.data.sender;
		if (sender == nick) {
			sender = "Me";
		} else {
			notify('<strong>' + message.data.sender + '</strong>: ' + message.data.text, 'default', 2000);
		}
		terminal.innerHTML += "<p>" + sender + ": " + message.data.text + "</p>";
		terminal.scrollTop = terminal.scrollHeight;
	} else if (message.action == "changenick") {
		terminal.innerHTML += "<p><i>'" + message.data.oldnick + "' is now called '" + message.data.newnick + "'</i><p>";
		terminal.scrollTop = terminal.scrollHeight;
	}
};

function send() {
	var message = {
		"action": "message",
		"data": {
			"sender": nick,
			"text": sendtxt.value
		}
	}
	ws.send(JSON.stringify(message));
	terminal.scrollTop = terminal.scrollHeight;
	sendtxt.value = "";
}

function setNick() {
	var message = {
		"action": "changenick",
		"data": {
			"oldnick": nick,
			"newnick": nickbox.value
		}
	}
	nick = message.data.newnick;
	ws.send(JSON.stringify(message));
	terminal.scrollTop = terminal.scrollHeight;
	sendtxt.focus();
}

function notify(message, type, timeout) {
	var id = Math.floor((Math.random() * 99999) + 1);
	notdiv.after('<div id="noti'+id+'" class="alert alert-info alert-dismissible fade in out" role="alert">\
			<button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>' + message + '</div>');
	//setTimeout(function() { $('#noti'+id).remove();	}, timeout);
	var alert = $('#noti'+id).alert();
	window.setTimeout(function() { alert.alert('close') }, timeout);
}
		</script>
  </body>
</html>
